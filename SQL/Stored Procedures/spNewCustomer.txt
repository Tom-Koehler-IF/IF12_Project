DELIMITER //

DROP PROCEDURE spNewCustomer//

CREATE PROCEDURE spNewCustomer(
   IN FirstName CHAR(50),
   IN LastName CHAR(50),
   IN Street CHAR(50),
   IN StreetNumber CHAR(10),
   IN PostalCode CHAR(5),
   IN szCity CHAR(50),
   IN AccountName CHAR(50),
   IN LoginPassword CHAR(64)
)
BEGIN 
    DECLARE LoginKey INT = null;

    START TRANSACTION;

    -- new user as not Admin, if we are passed an account (A customer does not require a login)
	if AccountName is not null
	begin
    	CALL spCreateNewUser(AccountName, LoginPassword, 0);

    	SET LoginKey = (SELECT l.nKey FROM tblLogin l WHERE l.szAccountName = AccountName);
	end

    INSERT INTO tblCustomer (szFirstName, szLastName, szStreet, szStreetNumber, szPostalCode, szCity, nLoginKey) 
    VALUES (FirstName, LastName, Street, StreetNumber, PostalCode, szCity, LoginKey);

    COMMIT;
END //

DELIMITER ;
